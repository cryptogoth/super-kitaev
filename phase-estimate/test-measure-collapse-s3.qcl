// Test applying the measurement operator for the superposition of
// odd magic states, and seeing if we collapse to the same one over
// multiple measurements

include "magic-state/odd-superpose.qcl";
include "phase-estimate/operator-x.qcl";
include "utils/copy.qcl";

qureg A[4];
qureg B[4];
qureg C[4];
qureg D[4];
qureg instrument[3];
qucond condition;
int c;

// Mix the instrument / control qubit
Mix(instrument);

// Create a magic state to copy |\psi_{4,1}>
CreateOddMagicSuperposition(A);

dump A;

dump instrument[0];
if (instrument[0]) {
	operatorX(A, B, 2);
} else {
	copy(B, A);
}

dump B;
dump A;

dump instrument[1];
if (instrument[1]) {
	operatorX(B, C, 2);
} else {
	copy(C, B);
}

dump C;
dump B;
dump A;

dump instrument[2];
if (instrument[2]) {
	operatorX(C, D, 2);
} else {
	copy(D, C);
}

dump D;
dump C;
dump B;
dump A;


measure instrument[0], c;

print "c= ", c;
dump instrument[0];

measure instrument[1], c;

print "c= ", c;
dump instrument[1];

measure instrument[2], c;

print "c= ", c;
dump instrument[2];

dump A;
dump B;
dump C;
dump D;